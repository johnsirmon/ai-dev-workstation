#!/bin/bash
# Weekly automated update script for AI Agent Development Workstation
# This script orchestrates the complete update process

set -e

echo "ðŸ¤– AI Agent Development Workstation - Weekly Update"
echo "=================================================="
echo "Started: $(date)"
echo ""

# Create necessary directories
mkdir -p reports logs

# Set up logging
LOG_FILE="logs/update-$(date +%Y-%m-%d).log"
exec 1> >(tee -a "$LOG_FILE")
exec 2> >(tee -a "$LOG_FILE" >&2)

# Function to check if Python packages are installed
check_python_deps() {
    echo "ðŸ“¦ Checking Python dependencies..."
    
    if ! python3 -c "import requests, packaging, bs4" 2>/dev/null; then
        echo "Installing required Python packages..."
        pip3 install requests packaging beautifulsoup4
    fi
    
    echo "âœ… Python dependencies ready"
}

# Function to run tool version checks
run_tool_checks() {
    echo ""
    echo "ðŸ”§ Running tool version checks..."
    echo "================================="
    
    if [ -f "scripts/update-tools.py" ]; then
        python3 scripts/update-tools.py
        echo "âœ… Tool version check completed"
    else
        echo "âŒ Tool version checker not found"
        exit 1
    fi
}

# Function to run forum monitoring
run_forum_monitoring() {
    echo ""
    echo "ðŸ“¡ Running forum monitoring..."
    echo "=============================="
    
    if [ -f "scripts/forum-monitor.py" ]; then
        python3 scripts/forum-monitor.py
        echo "âœ… Forum monitoring completed"
    else
        echo "âŒ Forum monitor not found"
        exit 1
    fi
}

# Function to update MCP server configurations
update_mcp_configs() {
    echo ""
    echo "ðŸ”Œ Updating MCP server configurations..."
    echo "======================================="
    
    # Check if MCP servers are up to date
    if command -v npx &> /dev/null; then
        echo "Checking MCP server versions..."
        
        # Update context7 if available
        if npx --yes @upstash/context7-mcp --version &> /dev/null; then
            echo "âœ… Context7 MCP server is available"
        else
            echo "âš ï¸  Context7 MCP server not accessible - check configuration"
        fi
        
        # Update other MCP servers
        echo "âœ… MCP server check completed"
    else
        echo "âš ï¸  npm/npx not found - MCP servers may not be available"
    fi
}

# Function to generate weekly summary
generate_summary() {
    echo ""
    echo "ðŸ“Š Generating weekly summary..."
    echo "=============================="
    
    SUMMARY_FILE="reports/weekly-summary-$(date +%Y-%m-%d).md"
    
    cat > "$SUMMARY_FILE" << EOF
# Weekly AI Agent Development Update
*Generated: $(date)*

## Summary
This weekly update includes:
- âœ… Tool version checks and updates
- âœ… Community forum monitoring
- âœ… MCP server configuration updates
- âœ… Trending tool analysis

## Files Updated
- \`config/tools-tracking.json\` - Tool version tracking
- \`README.md\` - Updated with latest versions and trending tools
- \`reports/community-insights-$(date +%Y-%m-%d).md\` - Community insights

## Next Steps
1. Review the community insights report for emerging trends
2. Evaluate any new trending tools for potential inclusion
3. Test any updated tool versions in development environment
4. Consider updating development workflow based on new findings

## Automation Status
- ðŸ¤– **Automated**: Tool version checking
- ðŸ¤– **Automated**: Forum monitoring
- ðŸ¤– **Automated**: README updates
- ðŸ‘¤ **Manual**: Tool evaluation and integration decisions

---
*This update was generated automatically by the AI Agent Development Workstation update system.*
EOF

    echo "âœ… Weekly summary generated: $SUMMARY_FILE"
}

# Function to commit changes if any
commit_changes() {
    echo ""
    echo "ðŸ“ Checking for changes to commit..."
    echo "==================================="
    
    if git diff --quiet && git diff --cached --quiet; then
        echo "ðŸ“„ No changes to commit"
    else
        echo "ðŸ“ Changes detected, creating commit..."
        
        # Add all tracked files that have been modified
        git add -u
        
        # Add new reports
        git add reports/ 2>/dev/null || true
        
        # Add updated config
        git add config/tools-tracking.json 2>/dev/null || true
        
        # Commit with automated message
        git commit -m "Weekly automated update - $(date +%Y-%m-%d)

- Updated tool versions and tracking
- Added community insights report
- Refreshed trending tools analysis

ðŸ¤– Generated by AI Agent Development Workstation automation"
        
        echo "âœ… Changes committed successfully"
    fi
}

# Main execution
main() {
    echo "ðŸš€ Starting automated update process..."
    
    # Check dependencies
    check_python_deps
    
    # Run tool checks
    run_tool_checks
    
    # Run forum monitoring
    run_forum_monitoring
    
    # Update MCP configurations
    update_mcp_configs
    
    # Generate summary
    generate_summary
    
    # Commit changes
    commit_changes
    
    echo ""
    echo "ðŸŽ‰ Weekly update completed successfully!"
    echo "======================================"
    echo "Completed: $(date)"
    echo "Log file: $LOG_FILE"
    echo ""
    echo "ðŸ“‹ Next actions to consider:"
    echo "1. Review the generated reports in the reports/ directory"
    echo "2. Check for any new trending tools that might be worth investigating"
    echo "3. Test any updated tool versions in your development environment"
    echo "4. Consider updating your development workflow based on community insights"
    echo ""
}

# Run main function
main